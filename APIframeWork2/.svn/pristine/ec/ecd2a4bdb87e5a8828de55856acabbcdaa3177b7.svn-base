#include "SceneCave.h"
#include "../Core/Camera.h"
#include "../Object/Stage.h"
#include "../Object/Player.h"
#include "../Collider/ColliderSphere.h"
#include "../Object/Minion.h"
#include "../Object/UIBar.h"
#include "../Object/UIPanel.h"
#include "SceneManager.h"
#include "../Core/PathManager.h"
#include "..//Object/Effect.h"
#include "..//Collider/ColliderRect.h"
#include "..//Object/Slime.h"
#include "../Animation/Animation.h"
#include "InGameScene.h"
#include "../Object/Tile.h"
#include "../Sound/SoundManager.h"
#include "../Object/UINum.h"
#include "../Core/Camera.h"
#include "../Object/Portal.h"
#include "../Object/ObjManager.h"
#include "../Object/UIInventory.h"

SceneCave::SceneCave()	:
	m_iLevel(0),
	m_pLevelNum(nullptr)
{
}

SceneCave::~SceneCave()
{
	SAFE_RELEASE(m_pStage);
	SAFE_RELEASE(m_pLevelNum);
}

bool SceneCave::Init()
{
	Layer* pStageLayer = FindLayer("Stage");

	m_pStage = Obj::CreateObj<Stage>("Stage", pStageLayer);

	char	strFileName[MAX_PATH] = {};

	const char* strRootPath = GET_SINGLE(PathManager)->FindPathMultiByte(DATA_PATH);

	if (strRootPath)
		strcat_s(strFileName, strRootPath);

	strcat_s(strFileName, "cave.tmp");

	m_pStage->SetStageType(STAGE_INDOOR);

	FILE* pLoadFile = nullptr;

	fopen_s(&pLoadFile, strFileName, "rb");

	if (pLoadFile)
	{
		if (m_pStage)
			m_pStage->Load(pLoadFile);

		fclose(pLoadFile);
	}

	if (!Scene::Init())
		return false;

	POSITION tCamPos = GET_SINGLE(Camera)->GetPos();

	Layer* pHUDLayer = FindLayer("HUD");

	Layer* pUILayer = FindLayer("UI");

	UIPanel* pLevelPanel = Obj::CreateObj<UIPanel>("LevelPanel", pHUDLayer, POSITION(50.f, 50.f), POSITION(50.f, 36.f));

	pLevelPanel->SetTexture("Mouse");
	pLevelPanel->SetImageOffset(650.f, 636.f);
	
	m_pLevelNum = (UINum*)m_pStage->CreateCloneObj("Num", "Num", pUILayer);

	m_pLevelNum->CreateNum(m_iLevel);
	m_pLevelNum->SetSpeed(0.f);

	m_pLevelNum->SetPosAll(POSITION(70.f, 62.f) + tCamPos);

	SAFE_RELEASE(pLevelPanel);

	CreateFarmEffect();

	CreateProtoTypes();

	CreateBatClone();

	CreateSlimeClone();

	CreateBugClone();

	CreateFlyClone();

	CreateRockCrabClone();

	ColliderRect* pPortal = m_pStage->AddCollider<ColliderRect>("OutPortal");

	pPortal->SetRect(32.f * 5.f, 32.f * 2.f, 32.f * 6.f, 32.f * 3.f);
	pPortal->AddCollisionFunction(CS_ENTER, this, &SceneCave::OutPortalCol);

	SAFE_RELEASE(pPortal); 
	
	LoadFile();

	int iTileSizeX = m_pStage->GetTileSizeX();
	int iTileSizeY = m_pStage->GetTileSizeY();

	while (true)
	{
		float fIndexX = (float)(rand() % 14 + 2);
		float fIndexY = (float)(rand() % 9 + 8);

		Tile* pTile = m_pStage->GetTile((float)iTileSizeX * fIndexX, (float)iTileSizeY * fIndexY);

		POSITION tPos = pTile->GetPos();

		TILE_OPTION eOption = pTile->GetTileOption();

		if (eOption == TO_NONE)
		{
			pTile->SetUpperImageOffset(416.f, 320.f);

			Layer* pLayer = FindLayer("Default");

			Portal* pPortal = Obj::CreateObj<Portal>("DownPortal", pLayer);

			pPortal->SetCallback(this, &SceneCave::NextLevel);
			pPortal->SetPos(iTileSizeX * fIndexX, iTileSizeY * fIndexY);

			ColliderRect* pDownPortal = pPortal->AddCollider<ColliderRect>("PortalBody");

			pDownPortal->SetRect(0.f, 0.f, 32.f, 32.f);
			pDownPortal->AddCollisionFunction(CS_ENTER, pPortal, &Portal::ColEnter);

			SAFE_RELEASE(pDownPortal);

			SAFE_RELEASE(pPortal);

			break;
		}
	}

	Layer* pLayer = FindLayer("Default");

	for (int i = 0; i < 20; ++i)
	{
		int iIndex = rand() % 8 + 17;

		float fIndexX = (float)(rand() % 14 + 2);
		float fIndexY = (float)(rand() % 12 + 5);

		Tile* pTile = m_pStage->GetTile((float)iTileSizeX * fIndexX, (float)iTileSizeY * fIndexY);

		POSITION tPos = pTile->GetPos();

		TILE_OPTION eOption = pTile->GetTileOption();

		if (eOption == TO_NOMOVE)
			continue;

		Obj* pRock = m_pStage->CreateCloneObj(m_vecstrProto[iIndex], "Rock", pLayer);

		if (pRock)
			m_pStage->SetBlock(pTile, pRock->GetBlock(), pRock);

		SAFE_RELEASE(pRock);

		pTile->SetTileOption(TO_NOMOVE);
	}

	return true;
}

int SceneCave::Update(float fTime)
{
	Scene::Update(fTime);

	POSITION tCamPos = GET_SINGLE(Camera)->GetPos();

	m_pLevelNum->CreateNum(m_iLevel);

	m_pLevelNum->SetPosAll(POSITION(70.f, 62.f) + tCamPos);

	return 0;
}

void SceneCave::OutPortalCol(Collider* pSrc, Collider* pDest, float fTime)
{
	string strDest = pDest->GetTag();

	if (strDest == "PlayerBody")
	{

		if (m_iLevel == 0)
		{
			GET_SINGLE(SceneManager)->CreateScene<InGameScene>("Main",SC_NEXT);

			Obj* pPlayer = GET_SINGLE(ObjManager)->GetPlayer();

			pPlayer->SetPos(752.f, 576.f);

			SAFE_RELEASE(pPlayer);
		}
			

		else
		{
			char strNum[32] = {};

			int iLevel = m_iLevel - 1;

			int iSize = sizeof(strNum) / sizeof(strNum[0]);

			for (int i=0;iLevel >=10;++i)
			{
				strNum[iSize - i - 1] = iLevel % 10;

				iLevel /= 10;
			}

			SceneCave* pScene = GET_SINGLE(SceneManager)->CreateScene<SceneCave>("Cave", SC_NEXT);

			pScene->SetLevel(m_iLevel - 1);

			Obj* pPlayer = GET_SINGLE(ObjManager)->GetPlayer();

			pPlayer->SetPos(32.f * 5.5f, 32.f * 5.5f);

			SAFE_RELEASE(pPlayer);
		}

		GET_SINGLE(SoundManager)->Stop(ST_BGM);
		GET_SINGLE(SoundManager)->Stop(ST_EFFECT);
	}
}

void SceneCave::NextLevel(Collider* pSrc, Collider* pDest, float fTime)
{
	string strDest = pDest->GetTag();

	if (strDest == "PlayerBody")
	{
		RECTANGLE tRC = ((ColliderRect*)pSrc)->GetWorldInfo();

		Tile* pTile = m_pStage->GetTile(tRC.l, tRC.t);

		if (pTile)
		{
			TILE_OPTION eOption = pTile->GetTileOption();

			if (eOption != TO_NOMOVE)
			{
				SceneCave* pScene = GET_SINGLE(SceneManager)->CreateScene<SceneCave>("Cave", SC_NEXT);

				pScene->SetLevel(m_iLevel + 1);

				GET_SINGLE(SoundManager)->Stop(ST_BGM);
				GET_SINGLE(SoundManager)->Stop(ST_EFFECT);

				Obj* pPlayer = GET_SINGLE(ObjManager)->GetPlayer();

				pPlayer->SetPos(32.f * 5.5f, 32.f * 5.5f);

				SAFE_RELEASE(pPlayer);
			}
		}
	}
}
